window.vBulletin=window.vBulletin||{};window.vBulletin.phrase=window.vBulletin.phrase||{};window.vBulletin.phrase.precache=window.vBulletin.phrase.precache||[];window.vBulletin.phrase.precache=$.merge(window.vBulletin.phrase.precache,["cancel_new_with_quote","create_new_conversation_with_quote","error_fetching_comments","error_fetching_quotes","error_x","existing_message_will_be_deleted","invalid_server_response_please_try_again","new_with_quote","please_click_on_the_quote_icon_of_the_post_you_want_to_quote","post_reply","visitor_message","x_comment","x_comments_lower"]);(function(A){var B=[".forum-conversation-content-widget",".blog-conversation-content-widget",".profile-widget"];if(!vBulletin.pageHasSelectors(B)){return false}vBulletin.conversation=vBulletin.conversation||{};vBulletin.conversation.contentEntryBox=vBulletin.conversation.contentEntryBox||{};vBulletin.conversation.fetchQuotes=function(C){if(C.nodeIds.length>0){A("body").css("cursor","wait");A.ajax({url:vBulletin.getAjaxBaseurl()+"/ajax/fetch-quotes",data:({nodeid:C.nodeIds}),type:"POST",dataType:"json",complete:function(E,D){console.log("fetch-quotes complete.");A("body").css("cursor","auto");if(typeof C.onComplete=="function"){C.onComplete(E,D)}},success:function(D,F,G){console.log("fetch-quotes successful! result:"+JSON.stringify(D));if(D){var E="";A.each(D,function(I,H){E+=JShtmlEncode(H)+"<br/><br/>"});if(typeof C.onSuccess=="function"){C.onSuccess(A.trim(E),F,G)}}else{if(typeof C.onError=="function"){C.onError(G,F,D)}}},error:function(F,E,D){console.log("fetch-quotes failed! error:"+D);if(typeof C.onError=="function"){C.onError(F,E,D)}}})}};vBulletin.conversation.replyWithQuotes={getPostReplyButtonSelector:function(){return"#btnPostReply-top"},getPostReplyQuoteCountSelector:function(){return".post-reply-btn .button-text-secondary"},getSlideoutSelector:function(){return".conversation-reply-slideout"},getTabsSelector:function(){return this.getSlideoutSelector()+" .content-entry-box-reply .ui-tabs-panel.pane"},getButtonSelector:function(){return this.getTabsSelector()+" form .action-buttons .right .button.primary"},getPrimaryButtonSelector:function(){return this.getButtonSelector()+".primary"},getQuotesButtonSelector:function(){return this.getPrimaryButtonSelector()+".add-more-quotes"},getVisibleQuotesButtonSelector:function(){return this.getTabsSelector()+":visible form .action-buttons .right .button.primary.add-more-quotes"},getSubmitButtonSelector:function(){return this.getPrimaryButtonSelector()+".submit"},getSelectedQuotesSelector:function(){return"ul.post-controls li.quoteCtrl.selected"},getTabsCountSelector:function(){return"div.content-entry-box-reply ul.content-entry-box-tabs li"},getContentEntryBoxTabCount:function(){return A(this.getTabsCountSelector()).length},sliderIsVisible:function(){return this.isVisible(this.getSlideoutSelector())&&A(this.getSlideoutSelector()).closest(".conversation-toolbar-wrapper").length==1},isVisible:function(C){if(A(C).length==0||A(C).hasClass("hide")||A(C).css("display").toLowerCase()==="none"){return false}else{return true}},hideSlideout:function(){this.hideElement(this.getSlideoutSelector())},hideElement:function(C){if(A(C).length==1&&A(C).css("display").toLowerCase()==="none"&&!A(C).hasClass("hide")){A(C).addClass("hide")}},addSubmitEventToForm:function(){var C=this.getTabsSelector()+" form.editor-form";A(C).each(function(){if(!A(this).hasClass("quote")){A(this).addClass("quote").on("submit",function(){return vBulletin.conversation.replyWithQuotes.clickSubmitButton(A(this))})}})},addMoreQuotesButtonToForm:function(){var D=this.getSubmitButtonSelector();var C=this.getQuotesButtonSelector();if(!A(C).length&&A(D).length){A(D).each(function(){var F=A("textarea",this.form).attr("id");var E=A("<button />").addClass("button primary add-more-quotes").attr("type","button").html(vBulletin.phrase.get("add_more_quotes")).on("click",{editorId:F},function(G){vBulletin.conversation.replyWithQuotes.clickAddMoreQuotesButton(G.data.editorId)});A(this).before(E)})}},clickPostReplyButton:function(C){if(C===0){if(this.sliderIsVisible()){A(this.getSlideoutSelector()).slideUp("slow",function(){A(this).addClass("hide");vBulletin.conversation.contentEntryBox.moveReplyToThreadBottom()})}else{vBulletin.conversation.contentEntryBox.moveReplyToThreadBottom()}}else{if(C===1){if(!this.sliderIsVisible()){A(this.getPostReplyButtonSelector()).click()}}}},clickQuoteIcon:function(C){this.collapseVisibleEditorOnQuoteClick();this.hideSlideout();this.addMoreQuotesButtonToForm();this.setPostReplyButtonStyle(C);this.clickPostReplyButton(C);this.addSubmitEventToForm()},clickAddMoreQuotesButton:function(C){if(vBulletin.ckeditor.editorExists(C)){vBulletin.ckeditor.getEditor(C).setData("")}A(this.getSlideoutSelector()).slideUp("slow",function(){A(this).addClass("hide")})},clickCancelButton:function(){this.clearSelectedQuotes();return true},clickSubmitButton:function(C){this.clearSelectedQuotes();return true},isQuoteSelected:function(){if(A(this.getSelectedQuotesSelector()).length>0){return true}else{return false}},clearSelectedQuotes:function(){if(this.isQuoteSelected()){A(this.getSelectedQuotesSelector()).each(function(C){A(this).removeClass("selected")})}this.setPostReplyButtonStyle(0)},setPostReplyButtonStyle:function(D){var C=A(this.getPostReplyQuoteCountSelector());if(D>0){C.text("("+D+")").closest(".split-button-wrapper").addClass("special")}else{C.text("").closest(".split-button-wrapper").removeClass("special")}},collapseVisibleEditorOnQuoteClick:function(){if(this.sliderIsVisible()){var C=A(this.getVisibleQuotesButtonSelector());if(A(C).length){A(C).click()}}},showAddWithQuotesButton:function(){var C=this.getQuotesButtonSelector();if(this.isQuoteSelected()){A(C).removeClass("hide")}else{A(C).addClass("hide")}},editorExists:function(){if(this.getContentEntryBoxTabCount()){return true}else{return false}}};vBulletin.conversation.contentEntryBox.moveReplyToThreadBottom=function(){var C=A(".conversation-toolbar-wrapper .conversation-reply-slideout");if(C.length==0){return }C.find("textarea").each(function(){var D=A(this).attr("id");if(vBulletin.ckeditor.editorExists(D)){vBulletin.ckeditor.destroyEditor(D)}});C.appendTo("#quick-reply-container").removeClass("hide").show();A("input[placeholder], textarea[placeholder]",C).placeholder();A("#quick-reply-container").removeClass("hide")};vBulletin.conversation.contentEntryBox.moveReplyToConversationToolbar=function(D){D=D||A("body");var C=A("#quick-reply-container .conversation-reply-slideout");if(C.length==0){return }C.find("textarea").each(function(){var E=A(this).attr("id");if(vBulletin.ckeditor.editorExists(E)){vBulletin.ckeditor.destroyEditor(E)}});A("#quick-reply-container").addClass("hide");C.appendTo(A(".conversation-toolbar-wrapper",D))};vBulletin.conversation.initialCommentCountToDisplay=1;vBulletin.conversation.init=function(){var G=A(".conversation-content-widget");var I=G.filter(".widget-tabs").tabs({selected:(A(".conversation-stream-view",G).length==1?1:0)});I.find(".widget-header .widget-tabs-nav li.ui-state-default:not(.ui-tabs-selected) a").off("click").on("click",function(){location.href=A(this).attr("data-href");return false});var K=new vBulletin.pagination({context:G,onPageChanged:function(N,P){M.updatePageNumber(N);if(!P){var O=M.getOption("customFilter");if(O){O.pagenum=N}M.applyFilters(false,false,false,true)}Responsive.ConversationContent.checkForSignature()}});var E=A(".conversation-toolbar-wrapper.scrolltofixed-floating",G);var J=function(){if(G.length>0){var N=(G.offset().top+(G.outerHeight()-parseFloat(G.css("border-bottom-width")))-E.height());return N}return 0};try{var L=new vBulletin.scrollToFixed({element:E,limit:J()})}catch(C){}var M=new vBulletin.conversation.filter({context:G,scrollToTop:G,pagination:K,onContentLoad:function(){L.updateLimit(J())}});A(".conversation-toolbar-wrapper form[name=toolbar-search-form]",G).off("submit.filtersearch").on("submit.filtersearch",function(){var N=M.getSelectedFilters(A(this));M.setOption("customFilter",N);M.resetFilters();return false});var F=function(){var Q=A(".post-controls .quoteCtrl.selected",G);if(Q.length>0){var P=[];Q.each(function(S){P.push(A(this).parent().attr("data-node-id"))});var O=function(U,S){var T;if(vBulletin.ckeditor.editorExists(U)){T=vBulletin.ckeditor.getEditor(U);if(T){T.setData("",function(){T.insertHtml(S);T.focus()})}}else{A("#"+U).val(S.replace(/\<br(\s*\/|)\>/gi,"\n")).focus()}};var R={nodeIds:P,onSuccess:function(S){var T=A(".content-entry-box .pane:visible .ckeditor-bare-box",G).first().attr("id");O(T,S)},onError:function(){openAlertDialog({title:vBulletin.phrase.get("conversation"),message:vBulletin.phrase.get("error_fetching_quotes"),iconType:"error"})}};vBulletin.conversation.fetchQuotes.apply(self,[R])}else{var N=A(".content-entry-box .pane:visible .ckeditor-bare-box",G).first().attr("id");if(vBulletin.ckeditor.editorExists(N)){vBulletin.ckeditor.getEditor(N).focus()}else{A("#"+N).focus()}}};A(".post-count").off("click").on("click",function(){var N=A(this);var O=N.closest(".list-item").data("nodeId");vBulletin.AJAX({url:vBulletin.getAjaxBaseurl()+"/ajax/render/conversation_item_permalink_overlay",data:{postid:O},success:function(P){openAlertDialog({title:vBulletin.phrase.get("share_post_link"),message:P})},error_phrase:"error_fetching_dialog"})});A(".conversation-toolbar .post-reply-btn").click(function(P,O){var N=this,Q=A(this).closest(".canvas-widget");if(Q.hasClass("conversation-content-widget")){vBulletin.conversation.contentEntryBox.moveReplyToConversationToolbar(Q);vBulletin.conversation.replyWithQuotes.showAddWithQuotesButton()}A(".conversation-reply-slideout",Q).hide().removeClass("hide").slideDown(function(){if(vBulletin.conversation.replyWithQuotes.editorExists()){var R=A(".content-entry-box .pane:visible .ckeditor-bare-box",Q).first().attr("id");A(".content-entry-box",Q).tabs("select",0);if(!O&&((vBulletin.ckeditor.editorExists(R)&&vBulletin.ckeditor.getEditor(R).getData()!="")||(!vBulletin.ckeditor.requiredScriptsLoaded&&A.trim(A("#"+R).val())!=""))){var S=(Q.hasClass("conversation-content-widget"))?"post_reply":"visitor_message";openConfirmDialog({title:vBulletin.phrase.get(S),message:vBulletin.phrase.get("existing_message_will_be_deleted"),iconType:"warning",onClickYes:function(){if(vBulletin.ckeditor.editorExists(R)){vBulletin.ckeditor.getEditor(R).setData("")}else{A("#"+R).val("")}A(N).triggerHandler("click",true)},onClickNo:function(){}});return false}if(Q.hasClass("conversation-content-widget")){if(!vBulletin.ckeditor.editorExists(R)){vBulletin.ckeditor.initEditor(R,{success:function(){F.apply(N)},error:function(T){A("#"+T).prop("disabled",false).removeClass("ckeditor-load-on-focus").closest(".content-entry-box").addClass("no-ckeditor")}})}else{F.apply(N)}}else{if(Q.hasClass("profile-widget")){if(!vBulletin.ckeditor.editorExists(R)){vBulletin.ckeditor.initEditor(R,{error:function(T){A("#"+T).prop("disabled",false).removeClass("ckeditor-load-on-focus").closest(".content-entry-box").addClass("no-ckeditor")}})}}}A("#quick-reply-container, #thread-view-tab .conversation-toolbar-wrapper, #profileTabs .activities-tab .conversation-toolbar-wrapper").off("focus",".content-entry-box .ckeditor-load-on-focus").on("focus",".content-entry-box .ckeditor-load-on-focus",function(){var T=A(this).attr("id");if(!vBulletin.ckeditor.editorExists(T)){vBulletin.ckeditor.initEditor(T,{error:function(U){A("#"+U).prop("disabled",false).removeClass("ckeditor-load-on-focus").closest(".content-entry-box").addClass("no-ckeditor")}})}})}})});A(".conversation-toolbar .new-quote-btn").click(function(S,Q){if(A(".post-controls .quoteCtrl.selected").length==0){openAlertDialog({title:vBulletin.phrase.get("conversation"),message:vBulletin.phrase.get("please_click_on_the_quote_icon_of_the_post_you_want_to_quote")});return false}var P=this;var O=A(".content-entry-box",G);var R=O.offset().top;var N=A(".content-entry-box .pane:visible .ckeditor-bare-box",G).first().attr("id");if(!Q&&((vBulletin.ckeditor.editorExists(N)&&vBulletin.ckeditor.getEditor(N).getData()!="")||(!vBulletin.ckeditor.requiredScriptsLoaded&&A.trim(A("#"+N).val())!=""))){openConfirmDialog({title:vBulletin.phrase.get("new_with_quote"),message:vBulletin.phrase.get("existing_message_will_be_deleted"),iconType:"warning",onClickYes:function(){if(vBulletin.ckeditor.editorExists(N)){vBulletin.ckeditor.getEditor(N).setData("")}else{A("#"+N).val("")}A(P).triggerHandler("click",true)},onClickNo:function(){vBulletin.animateScrollTop(R,{duration:500,complete:function(){if(vBulletin.ckeditor.editorExists(N)){vBulletin.ckeditor.getEditor(N).focus()}else{A("#"+N).focus()}}})}});return false}G.addClass("new-with-quote");A("#breadcrumbs .crumb:last").clone().html(vBulletin.phrase.get("new_with_quote")).after(A("#breadcrumbs .crumbSeparator:first").clone()).appendTo(A("#breadcrumbs"));A(".content-entry-box-header",O).html(vBulletin.phrase.get("create_new_conversation_with_quote"));A("form button[name=btnSubmit]",O).html(vBulletin.phrase.get("submit"));A("form input[name=parentid]",O).val(pageData.channelid);A("form .title-field",O).val("");A("button.cancel",O).off("click").on("click",function(T){openConfirmDialog({title:vBulletin.phrase.get("cancel_new_with_quote"),message:vBulletin.phrase.get("existing_message_will_be_deleted"),iconType:"warning",onClickYes:function(){location.reload()}})});if(!vBulletin.ckeditor.editorExists(N)){vBulletin.ckeditor.initEditor(N,{success:function(){F.apply(P)}})}else{F.apply(P)}R=O.offset().top;vBulletin.animateScrollTop(R,{duration:500,complete:function(){}})});A(".conversation-reply-slideout .action-buttons .cancel").click(function(){var N=function(){vBulletin.conversation.contentEntryBox.moveReplyToThreadBottom();vBulletin.conversation.replyWithQuotes.showAddWithQuotesButton()};var O=A(this).closest("form").find("textarea").eq(0).attr("id");if((vBulletin.ckeditor.editorExists(O)&&vBulletin.ckeditor.getEditor(O).getData()!="")||(!vBulletin.ckeditor.editorExists(O)&&A.trim(A("#"+O).val())!="")){var P=(A(this).closest(".canvas-widget").hasClass("conversation-content-widget"))?"post_reply":"visitor_message";openConfirmDialog({title:vBulletin.phrase.get(P),message:vBulletin.phrase.get("existing_message_will_be_deleted"),iconType:"warning",onClickYes:function(){vBulletin.conversation.replyWithQuotes.clickCancelButton();if(vBulletin.ckeditor.editorExists(O)){vBulletin.ckeditor.getEditor(O).setData("")}else{A("#"+O).val("")}A(".conversation-toolbar-wrapper .conversation-reply-slideout").slideUp(400,N)},onClickNo:function(){}});return false}if(vBulletin.ckeditor.editorExists(O)){}A(".conversation-toolbar-wrapper .conversation-reply-slideout").slideUp(400,N)});A(".userinfo .userSignatureIcon").each(function(){var N=A(this).find(".user-signature");if(A.trim(N.html()).length==0){N=A(this).closest(".list-item").find(".post-signature")}A(this).qtip({content:N,position:{my:"top left",at:"bottom center"},style:{classes:"ui-tooltip-shadow ui-tooltip-light ui-tooltip-rounded ui-tooltip-signature"},hide:{event:"unfocus"},show:{solo:true}})});var H=A(".conversation-list",G);A(".post-controls",H).disableSelection();H.off("click",".quoteCtrl").on("click",".quoteCtrl",function(){A(this).toggleClass("selected");var N=A(".post-reply-btn .button-text-secondary");var O=N.text().match(/[0-9]+/);O=O?Number(O[0]):0;if(A(this).hasClass("selected")){O++}else{O--}vBulletin.conversation.replyWithQuotes.clickQuoteIcon(O)});H.off("click",".post-history").on("click",".post-history",vBulletin.conversation.showPostHistory);H.off("click",".ipAddress").on("click",".ipAddress",vBulletin.conversation.showIp);H.off("click",".voteCtrl").on("click",".voteCtrl",function(N){if(A(N.target).closest(".bubble-flyout").length==1){vBulletin.conversation.showWhoVoted.apply(N.target,[N])}else{vBulletin.conversation.votePost.apply(this,[N])}return false});H.off("click",".editCtrl").on("click",".editCtrl",vBulletin.conversation.editPost);H.off("click",".flagCtrl").on("click",".flagCtrl",vBulletin.conversation.flagPost);H.off("click",".commentCtrl").on("click",".commentCtrl",function(N){vBulletin.conversation.toggleCommentBox.apply(this,[N])});if((typeof (vBulletin.inlinemod)!="undefined")&&(typeof (vBulletin.inlinemod.init)=="function")){vBulletin.inlinemod.init(G)}H.off("click",".post-comment-btn").on("click",".post-comment-btn",function(N){vBulletin.conversation.postComment.apply(this,[N,function(Q){if(Q){if(Q.redirecturl){location.replace(Q.redirecturl);return }var P=A(this).closest(".list-item"),O=Q.totalcomments,T=Math.ceil(O/vBulletin.conversation.COMMENTS_PER_PAGE),S=P.find(".conversation-comments-wrapper").removeClass("hide").find(".conversation-comments");A(this).closest(".comment-entry-box").addClass("has-comments").find(".comment-textbox").val("").trigger("update.elastic");var R=A(Q.template).appendTo(S);S.next(".comment-info.bottom").addClass("hide");P.find(".view-prev-btn").show().data("page-num",1).prev("label").hide();S.prev(".comment-info.top").removeClass("hide").find(".comment-pagination-control").removeClass(function(){return(O>1)?"hide":""}).end().find(".comment-total label").text(function(){var U=O>1?"x_comments_lower":"x_comment";return vBulletin.phrase.get(U,O)});vBulletin.scrollToAnchor("#post"+Q.nodeId)}}])});H.off("click",".conversation-comments-wrapper .view-prev-btn, .conversation-comments-wrapper .view-next-btn").on("click",".conversation-comments-wrapper .view-prev-btn, .conversation-comments-wrapper .view-next-btn",function(){A("body").css("cursor","wait");var R=A(this);var N=R.closest(".list-item");var S=N.find(".conversation-comments-wrapper");var O=S.find(".conversation-comments");var Q=Number(R.data("page-num"))||0;var P=R.closest(".canvas-widget").attr("data-widget-instance-id");A.ajax({url:vBulletin.getAjaxBaseurl()+"/ajax/fetch-comments",data:({page:Q,parentid:N.attr("data-node-id"),postindex:N.find(".conversation-body .post-count").text().replace("#",""),widgetInstanceId:P,isblogcomment:R.closest(".blog-list").length==1?1:0}),type:"POST",dataType:"json",complete:function(U,T){console.log("fetch-comments complete.");A("body").css("cursor","auto")},success:function(c,V,b){console.log("fetch-comments successful! result:"+JSON.stringify(c));if(c){if(!c.error){if(c.templates){var W=A("<ul />").attr("class",O.attr("class")),U=c.totalcomments;A.each(c.templates,function(d,e){W.append(e)});O.replaceWith(W);var Z=Number(W.find(".list-item:first-child .post-count span").text().replace(/\D/g,"")),a=Number(W.find(".list-item:last-child .post-count span").text().replace(/\D/g,"")),X=Math.ceil(U/vBulletin.conversation.COMMENTS_PER_PAGE),T,Y;if(R.hasClass("view-prev-btn")){T=R;Y=S.find(".view-next-btn")}else{T=S.find(".view-prev-btn");Y=R}Q=c.page;S.find(".comment-info.top").find(".comment-pagination-control > label").show().text(function(){return(Z==a)?Z:"{0} - {1}".format(Z,a)});if(Q==1){S.find(".comment-info.bottom").addClass("hide")}else{Z=a+1;a=Z+vBulletin.conversation.COMMENTS_PER_PAGE-1;a=(a>U)?U:a;S.find(".comment-info.bottom").removeClass("hide").find(".comment-pagination-control > label").text(function(){return(Z==a)?Z:"{0} - {1}".format(Z,a)})}T.data("page-num",Q+1);Y.data("page-num",((Q-1)||1));T.removeClass("hide-imp")[X>Q?"show":"hide"]().prev("label").show();Y[Q>1?"show":"hide"]()}}else{openAlertDialog({title:vBulletin.phrase.get("conversation"),message:vBulletin.phrase.get("error_x",c.error),iconType:"warning"})}}else{openAlertDialog({title:vBulletin.phrase.get("conversation"),message:vBulletin.phrase.get("invalid_server_response_please_try_again"),iconType:"error"})}},error:function(V,U,T){console.log("fetch-comments failed! error:"+T);openAlertDialog({title:vBulletin.phrase.get("conversation"),message:vBulletin.phrase.get("error_fetching_comments"),iconType:"error"})}})});A(".content-entry-box form").trigger("reset");vBulletin.conversation.bindEditFormEventHandlers("text");vBulletin.conversation.bindEditFormEventHandlers("comment");var D=A("li.conversation-starter").attr("data-node-id");if(pageData.threadmarking=="0"||pageData.userid=="0"){vBulletin.cookie.setBbarrayCookie("discussion_view",D,Math.round(new Date().getTime()/1000))}else{A.ajax({url:vBulletin.getAjaxBaseurl()+"/ajax/api/node/markRead",data:{nodeid:D},type:"POST",datatype:"json",complete:function(){},success:function(N){if(N&&!N.error){console.log("Topic "+D+" is marked read successfully!")}else{console.log("Topic "+D+" is marked read failed: "+N.error)}},error:function(P,O,N){console.log("Topic "+D+" is marked read failed:"+N)}})}};A(document).ready(function(){vBulletin.conversation.init()})})(jQuery);